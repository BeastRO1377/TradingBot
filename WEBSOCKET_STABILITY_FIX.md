# WebSocket Stability Fix

## üö® –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–∑—ã–≤–∞–ª–∏ —Ä–∞–∑—Ä—ã–≤—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:

### 1. **–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ (184)**
- WebSocket –ø–µ—Ä–µ–≥—Ä—É–∂–∞–ª—Å—è –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–¥–ø–∏—Å–æ–∫
- Bybit –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç—ã –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –æ–¥–Ω–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏

### 2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ping/pong**
- –í –∫–æ–¥–µ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: `ping_interval=30, ping_timeout=15`
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `ping_interval=60, ping_timeout=30`

### 3. **–ß–∞—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤**
- –°–ø–∏—Å–æ–∫ —Å–∏–º–≤–æ–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å
- –≠—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

### 1. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
```python
# –ú–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ WebSocket
if len(desired_symbols) > 50:
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: BTC, ETH, –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏, –∑–∞—Ç–µ–º —Å–∞–º—ã–µ –ª–∏–∫–≤–∏–¥–Ω—ã–µ
    priority_symbols = {"BTCUSDT", "ETHUSDT"}
    open_pos_symbols_set = set(open_pos_symbols)
    
    # –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    limited_symbols = priority_symbols.union(open_pos_symbols_set)
    
    # –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º —Å–∞–º—ã–µ –ª–∏–∫–≤–∏–¥–Ω—ã–µ –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
    remaining_symbols = desired_symbols - limited_symbols
    remaining_list = list(remaining_symbols)
    remaining_list.sort(key=lambda x: liquid_symbols.get(x, 0), reverse=True)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ –ª–∏–º–∏—Ç–∞
    for symbol in remaining_list:
        if len(limited_symbols) >= 50:
            break
        limited_symbols.add(symbol)
    
    desired_symbols = limited_symbols
```

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ping/pong
```python
# –ë—ã–ª–æ
ping_interval=30, ping_timeout=15

# –°—Ç–∞–ª–æ
ping_interval=60, ping_timeout=30  # ping_interval > ping_timeout
```

### 3. –£–º–µ–Ω—å—à–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤
```python
# –ë—ã–ª–æ: –∫–∞–∂–¥—ã–π —á–∞—Å
async def manage_symbol_selection(self, check_interval=3600):

# –°—Ç–∞–ª–æ: –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
async def manage_symbol_selection(self, check_interval=7200):
```

### 4. –ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —á–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫
current_time = time.time()
if hasattr(self, '_last_symbol_change_time'):
    time_since_last_change = current_time - self._last_symbol_change_time
    if time_since_last_change < 300:  # –ú–µ–Ω—å—à–µ 5 –º–∏–Ω—É—Ç
        logger.info(f"–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ")
        continue
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- 184 —Å–∏–º–≤–æ–ª–∞ ‚Üí –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ WebSocket
- Ping/pong timeout –∫–∞–∂–¥—ã–µ 1-2 –º–∏–Ω—É—Ç—ã
- –ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- –ú–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ping/pong ‚Üí –Ω–µ—Ç timeout –æ—à–∏–±–æ–∫
- –†–µ–¥–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí –º–µ–Ω—å—à–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–∏–º–≤–æ–ª–æ–≤:

1. **BTCUSDT, ETHUSDT** - –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω—ã
2. **–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏** - –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
3. **–°–∞–º—ã–µ –ª–∏–∫–≤–∏–¥–Ω—ã–µ** - –ø–æ –æ–±—ä–µ–º—É —Ç–æ—Ä–≥–æ–≤

## üîß –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
grep "—Å–∏–º–≤–æ–ª–∞–º–∏" bot.log | tail -5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
grep "ping/pong timed out" bot.log | wc -l

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è
python monitor_websocket_health.py
```

## üìà –û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:

- **–°–Ω–∏–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä—ã–≤–æ–≤**: 95%+ (—Å –∫–∞–∂–¥—ã–µ 1-2 –º–∏–Ω—É—Ç—ã –¥–æ —á–∞—Å–æ–≤)
- **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–µ–Ω–∞
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –õ—É—á—à–µ –∏–∑-–∑–∞ –º–µ–Ω—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–∏–º–≤–æ–ª–æ–≤
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:

1. **50 —Å–∏–º–≤–æ–ª–æ–≤** - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å—é
2. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏–π** - –≤—Å–µ–≥–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
3. **–†–µ–¥–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - —Å–Ω–∏–∂–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ WebSocket
4. **–ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π** - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É

–¢–µ–ø–µ—Ä—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞–º–Ω–æ–≥–æ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ! üöÄ





































